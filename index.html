<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø¬ÙŠ Ø³ØªÙˆØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0a58ca;
      --bg: #f4f7fb;
      --card: #ffffff;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: "Cairo", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #222;
    }

    .app-header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .user-info-small {
      font-size: 0.75rem;
      text-align: left;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 12px 40px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
    }

    .card-title {
      margin: 0 0 12px;
      font-size: 1rem;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.badge {
      font-size: 0.7rem;
      background: rgba(13,110,253,0.08);
      color: var(--primary-dark);
      padding: 2px 8px;
      border-radius: 999px;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .input-group label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 3px;
      color: #4b5563;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #f9fafb;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.15);
      background: #fff;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.1s, box-shadow 0.1s;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 3px 8px rgba(37,99,235,0.3);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.75rem;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .tab {
      flex: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
    }

    .tab.active {
      background: var(--primary);
      color: #fff;
    }

    .hidden {
      display: none !important;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    th {
      background: #f3f4f6;
      color: #374151;
      font-weight: 600;
    }

    tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
    }

    .status-pending {
      background: #fbbf24;
      color: #92400e;
    }

    .status-approved {
      background: #22c55e;
      color: #14532d;
    }

    .status-rejected {
      background: #f87171;
      color: #7f1d1d;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .stat-pill {
      flex: 1 1 120px;
      background: #eff6ff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #1e3a8a;
    }

    .alert {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .alert-success {
      background: #ecfdf3;
      color: #14532d;
      border: 1px solid #bbf7d0;
    }

    .alert-error {
      background: #fef2f2;
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }

    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #dbeafe, #eff6ff);
      padding: 20px;
    }

    .login-card {
      width: 100%;
      max-width: 360px;
      background: #fff;
      border-radius: 22px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.25);
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top, rgba(59,130,246,0.35), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .login-inner {
      position: relative;
      z-index: 1;
    }

    .login-title {
      font-size: 1.15rem;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .login-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .login-footer {
      text-align: center;
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    .pill-outline {
      display: inline-flex;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.9);
      font-size: 0.7rem;
      color: #4b5563;
      margin-bottom: 8px;
      gap: 6px;
      align-items: center;
    }

    .logout-btn {
      font-size: 0.7rem;
      background: rgba(15,23,42,0.15);
      color: #e5e7eb;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .app-header h1 {
        font-size: 0.95rem;
      }
      .user-info-small {
        display: none;
      }
    }
  </style>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginView" class="login-wrapper">
    <div class="login-card">
      <div class="login-inner">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <h2 class="login-title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø¬ÙŠ Ø³ØªÙˆØ±</h2>
            <div class="login-sub">Ø¥Ø¬Ø§Ø²Ø§Øª â€“ Ø¥Ø¶Ø§ÙÙŠ â€“ ØªÙ‚Ø§Ø±ÙŠØ±</div>
          </div>
          <div style="width:40px;height:40px;border-radius:999px;background:linear-gradient(135deg,#0ea5e9,#2563eb);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;box-shadow:0 6px 16px rgba(37,99,235,0.6);">
            HR
          </div>
        </div>

        <div class="pill-outline">
          <span>ğŸ‘¤</span>
          <span>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</span>
        </div>

        <div id="loginAlert" class="alert alert-error hidden"></div>

        <div class="input-group">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù (EmployeeID)</label>
          <input type="text" id="loginEmployeeId" placeholder="Ù…Ø«Ø§Ù„: A101" />
        </div>

        <div class="input-group">
          <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</label>
          <input type="password" id="loginPin" placeholder="4 Ø£Ø±Ù‚Ø§Ù… Ù…Ø«Ù„Ø§Ù‹" />
        </div>

        <button class="btn btn-primary" style="width:100%;margin-top:6px;" onclick="handleLogin()">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>

        <div class="login-footer">
          ÙˆØ§Ø¬Ù‡Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© â€“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© ÙÙŠ Google Sheets
        </div>
      </div>
    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div id="appView" class="hidden">
    <header class="app-header">
      <h1>Ù„ÙˆØ­Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</h1>
      <div>
        <div class="user-info-small" id="headerUserInfo"></div>
        <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <div class="container">

      <!-- Tabs -->
      <div class="card">
        <div class="tabs" id="mainTabs">
          <button class="tab active" data-target="employeePanel">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</button>
          <button class="tab hidden" data-target="managerPanel" id="managerTab">Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…</button>
          <button class="tab hidden" data-target="adminPanel" id="adminTab">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
      <div id="employeePanel" class="card">
        <h2 class="card-title">
          Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù
          <span class="badge" id="employeeNameBadge"></span>
        </h2>

        <div id="employeeAlert" class="alert hidden"></div>

        <div class="stats-row" id="leaveStatsRow"></div>

        <div class="card" style="margin-top:12px;background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

          <div class="input-group">
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="leaveStartDate" />
          </div>
          <div class="input-group">
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="leaveEndDate" />
          </div>
          <div class="input-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</label>
            <select id="leaveType">
              <option value="Annual">Ø³Ù†ÙˆÙŠØ©</option>
              <option value="Sick">Ù…Ø±Ø¶ÙŠØ©</option>
              <option value="Marriage">Ø²ÙˆØ§Ø¬</option>
              <option value="Bereavement1">ÙˆÙØ§Ø© (Ø¯Ø±Ø¬Ø© Ø£ÙˆÙ„Ù‰)</option>
              <option value="Bereavement2">ÙˆÙØ§Ø© (Ø¯Ø±Ø¬Ø© Ø«Ø§Ù†ÙŠØ©)</option>
              <option value="Exceptional">Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©</option>
              <option value="Holiday">Ø¥Ø¬Ø§Ø²Ø© Ø£Ø¹ÙŠØ§Ø¯ / Ø±Ø³Ù…ÙŠØ©</option>
            </select>
          </div>
          <div class="input-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="leaveComment" rows="2"></textarea>
          </div>
          <button class="btn btn-primary btn-sm" onclick="submitLeave()">
            Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©
          </button>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h3>
          <div class="table-wrapper">
            <table id="leaveTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th>Ø£ÙŠØ§Ù…</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h3>
          <div class="stats-row" id="otStatsRow"></div>
          <div class="table-wrapper">
            <table id="otTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… -->
      <div id="managerPanel" class="card hidden">
        <h2 class="card-title">
          Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
          <span class="badge">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</span>
        </h2>

        <div id="managerAlert" class="alert hidden"></div>

        <div class="card" style="background:#f9fafb;margin-bottom:14px;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø© ÙÙŠ Ø§Ù„Ù‚Ø³Ù…</h3>
          <button class="btn btn-secondary btn-sm" onclick="loadManagerLeaves()">
            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
          </button>
          <div style="margin-top:8px;" class="table-wrapper">
            <table id="managerLeaveTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th>Ø£ÙŠØ§Ù…</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ù‚Ø³Ù…</h3>
          <div class="input-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <input type="text" id="mgrOtEmployeeId" placeholder="EmployeeID" />
          </div>
          <div class="input-group">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="mgrOtDate" />
          </div>
          <div class="input-group">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
            <input type="number" id="mgrOtHours" step="0.25" />
          </div>
          <div class="input-group">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ ÙØ§Ø±Øº ÙŠØ¹Ù†ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù)</label>
            <input type="number" id="mgrOtRate" step="0.01" />
          </div>
          <button class="btn btn-primary btn-sm" onclick="managerAddOvertime()">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
          </button>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
      <div id="adminPanel" class="card hidden">
        <h2 class="card-title">
          Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
          <span class="badge">ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØªØµØ±</span>
        </h2>

        <button class="btn btn-secondary btn-sm" onclick="loadAdminReport()">
          ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        </button>

        <div id="adminAlert" class="alert hidden" style="margin-top:8px;"></div>

        <div id="adminSummary" style="margin-top:10px;"></div>

        <p style="font-size:0.8rem;color:#6b7280;margin-top:12px;">
          ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø¬Ø¯Ø§ÙˆÙ„ ØªÙØµÙŠÙ„ÙŠØ© (ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§ØªØŒ ÙƒÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ).
        </p>
      </div>
    </div>
  </div>

  <script>
    // ğŸ”— Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App Ù…Ù† Google Apps Script (Ø§Ù„Ø°ÙŠ ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbzB5c44f4j_GidCDRtQkEhbxNql0hKCbBnhk0pgTlG_OTVPjtIuN0DIGUn8YX2K3rrc/exec";

    let currentUser = null;

    function showView(isLoggedIn) {
      document.getElementById('loginView').classList.toggle('hidden', isLoggedIn);
      document.getElementById('appView').classList.toggle('hidden', !isLoggedIn);
    }

    function setAlert(id, message, type) {
      const el = document.getElementById(id);
      if (!el) return;
      if (!message) {
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
      el.classList.remove('alert-success', 'alert-error');
      if (type === 'success') el.classList.add('alert-success');
      else el.classList.add('alert-error');
    }

    // âš ï¸ Ù…Ù‡Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… text/plain Ù„ØªÙØ§Ø¯ÙŠ CORS (no preflight)
    async function apiCall(action, payload) {
      const body = JSON.stringify({ action, ...payload });
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body
      });
      return res.json();
    }

    async function handleLogin() {
      const empId = document.getElementById('loginEmployeeId').value.trim();
      const pin = document.getElementById('loginPin').value.trim();

      if (!empId || !pin) {
        setAlert('loginAlert', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ', 'error');
        return;
      }

      try {
        setAlert('loginAlert', '', '');
        const data = await apiCall('login', { employeeId: empId, pin });

        if (!data.ok) {
          setAlert('loginAlert', data.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
          return;
        }

        currentUser = {
          employeeId: data.employee.EmployeeID,
          pin: pin,
          name: data.employee.Name,
          dept: data.employee.Department,
          role: data.employee.Role
        };

        document.getElementById('headerUserInfo').textContent =
          currentUser.name + " â€“ " + currentUser.employeeId + " (" + currentUser.role + ")";

        document.getElementById('employeeNameBadge').textContent =
          currentUser.name + " â€“ " + currentUser.employeeId;

        const mgrTab = document.getElementById('managerTab');
        const adminTab = document.getElementById('adminTab');
        if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
          mgrTab.classList.remove('hidden');
        } else {
          mgrTab.classList.add('hidden');
        }
        if (currentUser.role === 'Admin') {
          adminTab.classList.remove('hidden');
        } else {
          adminTab.classList.add('hidden');
        }

        showView(true);
        initTabs();
        await loadEmployeeDashboard();

        if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
          loadManagerLeaves();
        }

      } catch (err) {
        setAlert('loginAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById('loginEmployeeId').value = "";
      document.getElementById('loginPin').value = "";
      showView(false);
    }

    function initTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const target = tab.getAttribute('data-target');
          ['employeePanel','managerPanel','adminPanel'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
          });
          if (target) {
            document.getElementById(target).classList.remove('hidden');
          }

          if (target === 'managerPanel' && currentUser &&
              (currentUser.role === 'Manager' || currentUser.role === 'Admin')) {
            loadManagerLeaves();
          }
        });
      });
    }

    async function loadEmployeeDashboard() {
      if (!currentUser) return;
      try {
        setAlert('employeeAlert', '', '');
        const data = await apiCall('getDashboard', {
          employeeId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!data.ok) {
          setAlert('employeeAlert', data.error || 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
          return;
        }

        const lb = data.leaveBalance || { annual: 0, used: 0, remaining: 0 };
        const statsRow = document.getElementById('leaveStatsRow');
        statsRow.innerHTML = `
          <div class="stat-pill"><span>Ø±ØµÙŠØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©</span><strong>${lb.annual}</strong></div>
          <div class="stat-pill"><span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† Ø§Ù„Ø³Ù†ÙˆÙŠØ©)</span><strong>${lb.used}</strong></div>
          <div class="stat-pill"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©</span><strong>${lb.remaining}</strong></div>
        `;

        const leaveTbody = document.querySelector('#leaveTable tbody');
        leaveTbody.innerHTML = '';
        (data.leaves || []).forEach(req => {
          const tr = document.createElement('tr');
          const statusClass =
            req.Status === 'Approved'
              ? 'status-approved'
              : req.Status === 'Rejected'
              ? 'status-rejected'
              : 'status-pending';

          tr.innerHTML = `
            <td>${req.RequestID}</td>
            <td>${formatDate(req.StartDate)}</td>
            <td>${formatDate(req.EndDate)}</td>
            <td>${req.Days}</td>
            <td>${req.Type || ''}</td>
            <td><span class="status-badge ${statusClass}">${req.Status}</span></td>
          `;
          leaveTbody.appendChild(tr);
        });

        const otStatsRow = document.getElementById('otStatsRow');
        otStatsRow.innerHTML = `
          <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</span><strong>${data.overtime.totalHours || 0}</strong></div>
          <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</span><strong>${data.overtime.totalValue || 0}</strong></div>
        `;

        const otTbody = document.querySelector('#otTable tbody');
        otTbody.innerHTML = '';
        (data.overtime.records || []).forEach(rec => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${rec.OTID}</td>
            <td>${formatDate(rec.Date)}</td>
            <td>${rec.Hours}</td>
            <td>${rec.Rate}</td>
            <td>${rec.Value}</td>
          `;
          otTbody.appendChild(tr);
        });

      } catch (err) {
        setAlert('employeeAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function formatDate(value) {
      if (!value) return '';
      const d = new Date(value);
      if (isNaN(d)) return String(value).split('T')[0] || String(value);
      return d.toISOString().split('T')[0];
    }

    async function submitLeave() {
      if (!currentUser) return;

      const startDate = document.getElementById('leaveStartDate').value;
      const endDate = document.getElementById('leaveEndDate').value;
      const type = document.getElementById('leaveType').value;
      const comment = document.getElementById('leaveComment').value;

      if (!startDate || !endDate) {
        setAlert('employeeAlert', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©', 'error');
        return;
      }

      try {
        const data = await apiCall('submitLeave', {
          employeeId: currentUser.employeeId,
          pin: currentUser.pin,
          startDate,
          endDate,
          type,
          comment
        });

        if (!data.ok) {
          setAlert('employeeAlert', data.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©', 'error');
          return;
        }

        setAlert('employeeAlert', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­ (Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + data.requestId + ')', 'success');
        document.getElementById('leaveComment').value = '';
        await loadEmployeeDashboard();

        if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
          loadManagerLeaves();
        }
      } catch (err) {
        setAlert('employeeAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function loadManagerLeaves() {
      if (!currentUser) return;

      try {
        const data = await apiCall('getManagerLeaves', {
          managerId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©', 'error');
          return;
        }

        setAlert('managerAlert', '', '');

        const tbody = document.querySelector('#managerLeaveTable tbody');
        tbody.innerHTML = '';

        if (!data.leaves || data.leaves.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td>`;
          tbody.appendChild(tr);
          return;
        }

        data.leaves.forEach(req => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${req.RequestID}</td>
            <td>${req.EmployeeID}</td>
            <td>${req.EmployeeDepartment || ''}</td>
            <td>${formatDate(req.StartDate)}</td>
            <td>${formatDate(req.EndDate)}</td>
            <td>${req.Days}</td>
            <td>${req.Type || ''}</td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="managerDecision(${req.RequestID}, 'Approved')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
              <button class="btn btn-sm btn-secondary" onclick="managerDecision(${req.RequestID}, 'Rejected')">Ø±ÙØ¶</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function managerDecision(requestId, status) {
      if (!currentUser) return;

      try {
        const data = await apiCall('approveLeave', {
          managerId: currentUser.employeeId,
          pin: currentUser.pin,
          requestId,
          status,
          comment: ''
        });

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', 'error');
          return;
        }

        setAlert('managerAlert', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.', 'success');

        await loadManagerLeaves();
        await loadEmployeeDashboard();

      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function managerAddOvertime() {
      if (!currentUser) return;

      const empId = document.getElementById('mgrOtEmployeeId').value.trim();
      const date = document.getElementById('mgrOtDate').value;
      const hours = document.getElementById('mgrOtHours').value;
      const rate = document.getElementById('mgrOtRate').value;

      if (!empId || !date || !hours) {
        setAlert('managerAlert', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª', 'error');
        return;
      }

      try {
        const payload = {
          managerId: currentUser.employeeId,
          pin: currentUser.pin,
          employeeId: empId,
          date,
          hours
        };
        if (rate) payload.rate = rate;

        const data = await apiCall('addOvertime', payload);

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ', 'error');
          return;
        }

        setAlert('managerAlert', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ù‚ÙŠÙ…Ø©: ' + data.value, 'success');
        document.getElementById('mgrOtHours').value = '';
        document.getElementById('mgrOtRate').value = '';
        await loadEmployeeDashboard();
      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function loadAdminReport() {
      if (!currentUser) return;
      try {
        const data = await apiCall('adminReport', {
          adminId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!data.ok) {
          setAlert('adminAlert', data.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
          return;
        }

        setAlert('adminAlert', '', '');
        const s = data.summary;
        const div = document.getElementById('adminSummary');
        div.innerHTML = `
          <div class="stats-row">
            <div class="stat-pill"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span><strong>${s.totalEmployees}</strong></div>
            <div class="stat-pill"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</span><strong>${s.leave.pending}</strong></div>
            <div class="stat-pill"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ù‚Ø¨ÙˆÙ„Ø©</span><strong>${s.leave.approved}</strong></div>
            <div class="stat-pill"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©</span><strong>${s.leave.rejected}</strong></div>
          </div>
          <div class="stats-row">
            <div class="stat-pill"><span>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</span><strong>${s.overtime.totalHours}</strong></div>
            <div class="stat-pill"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</span><strong>${s.overtime.totalValue}</strong></div>
          </div>
        `;
      } catch (err) {
        setAlert('adminAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      showView(false);
    });
  </script>
</body>
</html>
