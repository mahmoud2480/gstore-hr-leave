<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø¬ÙŠ Ø³ØªÙˆØ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #0d6efd;
      --primary-dark: #0a58ca;
      --bg: #f4f7fb;
      --card: #ffffff;
      --radius: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: "Cairo", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: #222;
    }

    .app-header {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .app-header h1 {
      margin: 0;
      font-size: 1.2rem;
    }

    .user-info-small {
      font-size: 0.75rem;
      text-align: left;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 12px 40px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      margin-bottom: 18px;
    }

    .card-title {
      margin: 0 0 12px;
      font-size: 1rem;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.badge {
      font-size: 0.7rem;
      background: rgba(13,110,253,0.08);
      color: var(--primary-dark);
      padding: 2px 8px;
      border-radius: 999px;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .input-group label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 3px;
      color: #4b5563;
    }

    .input-group input,
    .input-group select,
    .input-group textarea {
      width: 100%;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.85rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: #f9fafb;
    }

    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(13,110,253,0.15);
      background: #fff;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.1s, box-shadow 0.1s;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 3px 8px rgba(37,99,235,0.3);
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.75rem;
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .tab {
      flex: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
    }

    .tab.active {
      background: var(--primary);
      color: #fff;
    }

    .hidden {
      display: none !important;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: center;
    }

    th {
      background: #f3f4f6;
      color: #374151;
      font-weight: 600;
    }

    tr:hover {
      background: #f9fafb;
    }

    .status-badge {
      display: inline-block;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 0.7rem;
    }

    .status-pending {
      background: #fbbf24;
      color: #92400e;
    }

    .status-approved {
      background: #22c55e;
      color: #14532d;
    }

    .status-rejected {
      background: #f87171;
      color: #7f1d1d;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .stat-pill {
      flex: 1 1 120px;
      background: #eff6ff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #1e3a8a;
    }

    .alert {
      font-size: 0.8rem;
      padding: 6px 10px;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .alert-success {
      background: #ecfdf3;
      color: #14532d;
      border: 1px solid #bbf7d0;
    }

    .alert-error {
      background: #fef2f2;
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }

    .login-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #dbeafe, #eff6ff);
      padding: 20px;
    }

    .login-card {
      width: 100%;
      max-width: 360px;
      background: #fff;
      border-radius: 22px;
      padding: 18px 18px 20px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.25);
      position: relative;
      overflow: hidden;
    }

    .login-card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top, rgba(59,130,246,0.35), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .login-inner {
      position: relative;
      z-index: 1;
    }

    .login-title {
      font-size: 1.15rem;
      margin-bottom: 4px;
      color: #0f172a;
    }

    .login-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .login-footer {
      text-align: center;
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 8px;
    }

    .pill-outline {
      display: inline-flex;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(148,163,184,0.9);
      font-size: 0.7rem;
      color: #4b5563;
      margin-bottom: 8px;
      gap: 6px;
      align-items: center;
    }

    .logout-btn {
      font-size: 0.7rem;
      background: rgba(15,23,42,0.15);
      color: #e5e7eb;
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .filters-row .input-group {
      flex: 1 1 180px;
      margin-bottom: 0;
    }

    /* Overlay Ù…Ø´ØªØ±Ùƒ */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .overlay-card {
      background: #ffffff;
      border-radius: 18px;
      max-width: 800px;
      width: 95%;
      max-height: 90vh;
      overflow: auto;
      padding: 16px;
      box-shadow: 0 15px 35px rgba(15,23,42,0.35);
    }

    .overlay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .overlay-close {
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .app-header h1 {
        font-size: 0.95rem;
      }
      .user-info-small {
        display: none;
      }
    }
  </style>
</head>
<body>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginView" class="login-wrapper">
    <div class="login-card">
      <div class="login-inner">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div>
            <h2 class="login-title">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø¬ÙŠ Ø³ØªÙˆØ±</h2>
            <div class="login-sub">Ø¥Ø¬Ø§Ø²Ø§Øª â€“ Ø¥Ø¶Ø§ÙÙŠ â€“ ØªÙ‚Ø§Ø±ÙŠØ±</div>
          </div>
          <div style="width:40px;height:40px;border-radius:999px;background:linear-gradient(135deg,#0ea5e9,#2563eb);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.9rem;box-shadow:0 6px 16px rgba(37,99,235,0.6);">
            HR
          </div>
        </div>

        <div class="pill-outline">
          <span>ğŸ‘¤</span>
          <span>Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</span>
        </div>

        <div id="loginAlert" class="alert alert-error hidden"></div>

        <div class="input-group">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù (EmployeeID)</label>
          <input type="text" id="loginEmployeeId" placeholder="Ù…Ø«Ø§Ù„: A1" />
        </div>

        <div class="input-group">
          <label>Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ (PIN)</label>
          <input type="password" id="loginPin" placeholder="4 Ø£Ø±Ù‚Ø§Ù… Ù…Ø«Ù„Ø§Ù‹" />
        </div>

        <button class="btn btn-primary" style="width:100%;margin-top:6px;" onclick="handleLogin()">
          ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        </button>

        <div class="login-footer">
          Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø¬ÙŠ Ø³ØªÙˆØ±
        </div>
      </div>
    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div id="appView" class="hidden">
    <header class="app-header">
      <h1> Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ø´Ø±ÙƒØ© Ø¬ÙŠ Ø³ØªÙˆØ±</h1>
      <div>
        <div class="user-info-small" id="headerUserInfo"></div>
        <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <div class="container">

      <!-- Tabs -->
      <div class="card">
        <div class="tabs" id="mainTabs">
          <button class="tab active" data-target="employeePanel">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù</button>
          <button class="tab hidden" data-target="managerPanel" id="managerTab">Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…</button>
          <button class="tab hidden" data-target="adminPanel" id="adminTab">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
      <div id="employeePanel" class="card">
        <h2 class="card-title">
          Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù
          <span class="badge" id="employeeNameBadge"></span>
        </h2>

        <div id="employeeAlert" class="alert hidden"></div>

        <!-- Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª -->
        <div class="stats-row" id="leaveStatsRow"></div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
        <div style="margin:6px 0 12px; display:flex; gap:6px; flex-wrap:wrap;">
          <button class="btn btn-secondary btn-sm" onclick="loadEmployeeDashboard()">
            ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          </button>
          <button class="btn btn-primary btn-sm" onclick="openEmployeeRequests()">
            Ø·Ù„Ø¨Ø§Øª Ø£Ø®Ø±Ù‰ (Ø²ÙŠØ§Ø¯Ø© Ø±Ø§ØªØ¨ / Ù†Ù‚Ù„ / ØªØ¯Ø±ÙŠØ¨)
          </button>
        </div>

        <!-- Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
        <div class="card" style="margin-top:12px;background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>

          <div class="input-group">
            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="leaveStartDate" />
          </div>
          <div class="input-group">
            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="leaveEndDate" />
          </div>
          <div class="input-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</label>
            <select id="leaveType">
              <option value="Annual">Ø³Ù†ÙˆÙŠØ©</option>
              <option value="Sick">Ù…Ø±Ø¶ÙŠØ©</option>
              <option value="HourlyExceptional">Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ© Ø³Ø§Ø¹ÙŠØ©</option>
              <option value="Exceptional">Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ© (Ø£ÙŠØ§Ù…)</option>
              <option value="Marriage">Ø²ÙˆØ§Ø¬</option>
              <option value="Bereavement1">ÙˆÙØ§Ø© (Ø¯Ø±Ø¬Ø© Ø£ÙˆÙ„Ù‰)</option>
              <option value="Bereavement2">ÙˆÙØ§Ø© (Ø¯Ø±Ø¬Ø© Ø«Ø§Ù†ÙŠØ©)</option>
              <option value="Holiday">Ø¥Ø¬Ø§Ø²Ø© Ø£Ø¹ÙŠØ§Ø¯ / Ø±Ø³Ù…ÙŠØ©</option>
            </select>
          </div>
          <div class="input-group">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <textarea id="leaveComment" rows="2"></textarea>
          </div>
          <button class="btn btn-primary btn-sm" onclick="submitLeave()">
            Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©
          </button>
        </div>

        <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© -->
        <div class="card" style="margin-top:12px;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h3>
          <div class="table-wrapper">
            <table id="leaveTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th>Ø£ÙŠØ§Ù…</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ -->
        <div class="card" style="margin-top:12px;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</h3>

          <div class="input-group" style="max-width:220px;">
            <label>ØªØµÙÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</label>
            <select id="otMonthFilter" onchange="renderEmployeeOvertimeTable()">
              <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
            </select>
          </div>

          <div class="stats-row" id="otStatsRow"></div>

          <div class="table-wrapper">
            <table id="otTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… -->
      <div id="managerPanel" class="card hidden">
        <h2 class="card-title">
          Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…
          <span class="badge">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© + Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</span>
        </h2>

        <div id="managerAlert" class="alert hidden"></div>

        <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© -->
        <div class="card" style="background:#f9fafb;margin-bottom:14px;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø¹Ù„Ù‘Ù‚Ø© ÙÙŠ Ø§Ù„Ù‚Ø³Ù…</h3>
          <button class="btn btn-secondary btn-sm" onclick="loadManagerPanelData()">
            ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…
          </button>
          <div style="margin-top:8px;" class="table-wrapper">
            <table id="managerLeaveTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th>Ø£ÙŠØ§Ù…</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø¨Ù„ / Ø¨Ø¹Ø¯</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ù‚Ø³Ù… -->
        <div class="card" style="background:#f9fafb;margin-bottom:14px;">
          <h3 class="card-title" style="font-size:0.9rem;">ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø§Ù„Ù‚Ø³Ù…</h3>

          <div class="input-group">
            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="mgrOtEmployeeSelect">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
            </select>
          </div>
          <div class="input-group">
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="mgrOtDate" />
          </div>
          <div class="input-group">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
            <input type="number" id="mgrOtHours" step="0.25" />
          </div>
          <div class="input-group">
            <label>Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¹Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€“ ÙØ§Ø±Øº ÙŠØ¹Ù†ÙŠ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ù…ÙˆØ¸Ù)</label>
            <input type="number" id="mgrOtRate" step="0.01" />
          </div>
          <button class="btn btn-primary btn-sm" onclick="managerAddOvertime()">
            ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
          </button>
        </div>

        <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù„Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… -->
        <div class="card" style="background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù„Ù…ÙˆØ¸ÙÙŠ Ø§Ù„Ù‚Ø³Ù…</h3>

          <div class="filters-row">
            <div class="input-group" style="max-width:220px;">
              <label>ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</label>
              <select id="mgrOtMonthFilter" onchange="renderManagerOvertimeTable()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
              </select>
            </div>
          </div>

          <div class="stats-row" id="mgrOtStatsRow"></div>

          <div class="table-wrapper" style="margin-top:6px;">
            <table id="mgrOtTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
      <div id="adminPanel" class="card hidden">
        <h2 class="card-title">
          Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
          <span class="badge">ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØªØµØ± + ØªÙØ§ØµÙŠÙ„</span>
        </h2>

        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;">
          <button class="btn btn-secondary btn-sm" onclick="loadAdminReport()">
            ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
          </button>
          <button class="btn btn-primary btn-sm" onclick="openAdminRequests()">
            ÙˆØ§Ø¬Ù‡Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
          </button>
        </div>

        <div id="adminAlert" class="alert hidden" style="margin-top:0;"></div>

        <!-- Ù…Ù„Ø®Øµ Ø¹Ø§Ù… -->
        <div id="adminSummary" style="margin-top:10px;"></div>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div class="card" style="margin-top:14px;background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>

          <div class="filters-row">
            <div class="input-group">
              <label>Ø§Ù„Ù‚Ø³Ù…</label>
              <select id="admEmpDeptFilter" onchange="renderAdminEmployeesTable()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
              </select>
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø¯ÙˆØ±</label>
              <select id="admEmpRoleFilter" onchange="renderAdminEmployeesTable()">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="Employee">Employee</option>
                <option value="Manager">Manager</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select id="admEmpActiveFilter" onchange="renderAdminEmployeesTable()">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="Active">Ù†Ø´Ø·</option>
                <option value="Inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
              </select>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="admEmpTable">
              <thead>
                <tr>
                  <th>EmployeeID</th>
                  <th>Ø§Ù„Ø§Ø³Ù…</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„Ø¯ÙˆØ±</th>
                  <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                  <th>Ù†Ø´Ø·ØŸ</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª -->
        <div class="card" style="margin-top:14px;background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</h3>

          <div class="filters-row">
            <div class="input-group">
              <label>Ø§Ù„Ù‚Ø³Ù…</label>
              <select id="admLeaveDeptFilter" onchange="renderAdminLeavesTable()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
              </select>
            </div>
            <div class="input-group">
              <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select id="admLeaveStatusFilter" onchange="renderAdminLeavesTable()">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
              </select>
            </div>
            <div class="input-group">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</label>
              <select id="admLeaveTypeFilter" onchange="renderAdminLeavesTable()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="Annual">Annual</option>
                <option value="Sick">Sick</option>
                <option value="HourlyExceptional">HourlyExceptional</option>
                <option value="Exceptional">Exceptional</option>
                <option value="Marriage">Marriage</option>
                <option value="Bereavement1">Bereavement1</option>
                <option value="Bereavement2">Bereavement2</option>
                <option value="Holiday">Holiday</option>
              </select>
            </div>
          </div>

          <div class="table-wrapper">
            <table id="admLeaveTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ù…Ù†</th>
                  <th>Ø¥Ù„Ù‰</th>
                  <th>Ø£ÙŠØ§Ù…</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ -->
        <div class="card" style="margin-top:14px;background:#f9fafb;">
          <h3 class="card-title" style="font-size:0.9rem;">Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</h3>

          <div class="filters-row">
            <div class="input-group">
              <label>Ø§Ù„Ù‚Ø³Ù…</label>
              <select id="admOtDeptFilter" onchange="renderAdminOvertimeTable()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
              </select>
            </div>
            <div class="input-group" style="max-width:220px;">
              <label>Ø§Ù„Ø´Ù‡Ø±</label>
              <select id="admOtMonthFilter" onchange="renderAdminOvertimeTable()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>
              </select>
            </div>
          </div>

          <div class="stats-row" id="admOtStatsRow"></div>

          <div class="table-wrapper">
            <table id="admOtTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (Overlay Ù…Ø´ØªØ±Ùƒ Ù„Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©) -->
  <div id="requestsOverlay" class="overlay hidden">
    <div class="overlay-card">
      <div class="overlay-header">
        <h3 style="margin:0;font-size:1rem;">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
        <button class="overlay-close" onclick="closeRequestsOverlay()">âœ•</button>
      </div>

      <!-- Ø¬Ø²Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù -->
      <div id="requestsEmployeeView">
        <p style="font-size:0.8rem;color:#6b7280;margin-bottom:8px;">
          ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨Ø§Øª Ù…Ø«Ù„: Ø²ÙŠØ§Ø¯Ø© Ø±Ø§ØªØ¨ØŒ Ù†Ù‚Ù„ØŒ ØªØ¯Ø±ÙŠØ¨ØŒ Ø³Ù„ÙØ©ØŒ Ø£Ùˆ Ø£ÙŠ Ø·Ù„Ø¨ Ø¥Ø¯Ø§Ø±ÙŠ Ø¢Ø®Ø±.
        </p>

        <div class="card" style="margin-bottom:12px;background:#f9fafb;">
          <h4 class="card-title" style="font-size:0.85rem;">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h4>

          <div class="input-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</label>
            <select id="reqType">
              <option value="SalaryRaise">Ø²ÙŠØ§Ø¯Ø© Ø±Ø§ØªØ¨</option>
              <option value="Transfer">Ù†Ù‚Ù„ Ù‚Ø³Ù…</option>
              <option value="Training">Ø·Ù„Ø¨ ØªØ¯Ø±ÙŠØ¨</option>
              <option value="Loan">Ø³Ù„ÙØ© / Ù‚Ø±Ø¶</option>
              <option value="Other">Ø·Ù„Ø¨ Ø¢Ø®Ø±</option>
            </select>
          </div>

          <div class="input-group">
            <label>Ø¹Ù†ÙˆØ§Ù† Ù…Ø®ØªØµØ± Ù„Ù„Ø·Ù„Ø¨</label>
            <input type="text" id="reqSubject" placeholder="Ù…Ø«Ø§Ù„: Ø·Ù„Ø¨ Ø²ÙŠØ§Ø¯Ø© Ø±Ø§ØªØ¨ / Ù†Ù‚Ù„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠÙƒ" />
          </div>

          <div class="input-group">
            <label>Ø´Ø±Ø­ Ø§Ù„Ø·Ù„Ø¨</label>
            <textarea id="reqDescription" rows="3" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø®ØªØµØ§Ø±"></textarea>
          </div>

          <div class="stats-row">
            <div class="input-group" style="flex:1 1 120px;">
              <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¥Ù† ÙˆØ¬Ø¯)</label>
              <input type="number" id="reqAmount" step="1" placeholder="Ù…Ø«Ø§Ù„: 200000" />
            </div>
            <div class="input-group" style="flex:1 1 120px;">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· (Ø¥Ù† ÙˆØ¬Ø¯)</label>
              <input type="number" id="reqInstallment" step="1" />
            </div>
          </div>

          <div class="stats-row">
            <div class="input-group" style="flex:1 1 160px;">
              <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ ØªØ¯Ø±ÙŠØ¨)</label>
              <input type="text" id="reqTraining" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© / Ø§Ù„Ø¬Ù‡Ø©" />
            </div>
            <div class="input-group" style="flex:1 1 160px;">
              <label>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ù„Ù†Ù‚Ù„ Ø¥Ù„ÙŠÙ‡</label>
              <input type="text" id="reqTransferDept" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠÙƒØŒ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª" />
            </div>
          </div>

          <button class="btn btn-primary btn-sm" onclick="submitEmployeeRequest()">
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
          </button>
          <div id="reqEmployeeAlert" class="alert hidden" style="margin-top:8px;"></div>
        </div>

        <div class="card" style="background:#fff;">
          <h4 class="card-title" style="font-size:0.85rem;">Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
          <div class="table-wrapper">
            <table id="employeeReqTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                  <th>Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Ø¬Ø²Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
      <div id="requestsAdminView" class="hidden">
        <p style="font-size:0.8rem;color:#6b7280;margin-bottom:8px;">
          Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§.
        </p>

        <div class="card" style="background:#f9fafb;">
          <h4 class="card-title" style="font-size:0.85rem;">Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4>
          <div class="table-wrapper">
            <table id="adminReqTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„Ù‚Ø³Ù…</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="reqAdminAlert" class="alert hidden" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ†• Ù…ÙˆØ¯Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© -->
  <div id="requestDetailsModal" class="overlay hidden">
    <div class="overlay-card" style="max-width:700px;">
      <div class="overlay-header">
        <h3 style="margin:0;font-size:1rem;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h3>
        <button class="overlay-close" onclick="closeRequestDetails()">âœ•</button>
      </div>

      <div id="requestDetailsContent" style="font-size:0.85rem;margin-bottom:10px;"></div>

      <div class="input-group">
        <label>Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
        <textarea id="adminReplyInput" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù‡Ù†Ø§..."></textarea>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn btn-primary btn-sm" onclick="saveAdminRequestAction('Approved')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
        <button class="btn btn-secondary btn-sm" onclick="saveAdminRequestAction('Rejected')">Ø±ÙØ¶</button>
        <button class="btn btn-secondary btn-sm" onclick="saveAdminRequestAction('replyOnly')">Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙ‚Ø·</button>
      </div>
    </div>
  </div>

  <script>
    // Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App
    const API_URL = "https://script.google.com/macros/s/AKfycbx9A4Caw74lGgJkld6iHSB1rj3eY5od9L9pxBw51BwCu4MY3wKQnaeJCaP8P8QSN-p8/exec";

    let currentUser = null;
    let employeeOTRecords = [];
    let managerEmployeesList = [];
    let managerOvertimeRecords = [];

    let adminEmployees = [];
    let adminLeaves = [];
    let adminOvertime = [];

    // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let employeeRequests = [];
    let adminRequests = [];
    let currentOpenedRequestId = null; // ğŸ†• Ù„Ù„Ù€ Modal

    function showView(isLoggedIn) {
      document.getElementById('loginView').classList.toggle('hidden', isLoggedIn);
      document.getElementById('appView').classList.toggle('hidden', !isLoggedIn);
    }

    function setAlert(id, message, type) {
      const el = document.getElementById(id);
      if (!el) return;
      if (!message) {
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
      el.classList.remove('alert-success', 'alert-error');
      if (type === 'success') el.classList.add('alert-success');
      else el.classList.add('alert-error');
    }

    async function apiCall(action, payload) {
      const body = JSON.stringify({ action, ...payload });
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain" },
        body: body
      });
      return res.json();
    }

    async function handleLogin() {
      const empId = document.getElementById('loginEmployeeId').value.trim();
      const pin = document.getElementById('loginPin').value.trim();

      if (!empId || !pin) {
        setAlert('loginAlert', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ', 'error');
        return;
      }

      try {
        setAlert('loginAlert', '', '');
        const data = await apiCall('login', { employeeId: empId, pin });

        if (!data.ok) {
          setAlert('loginAlert', data.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
          return;
        }

        currentUser = {
          employeeId: data.employee.EmployeeID,
          pin: pin,
          name: data.employee.Name,
          dept: data.employee.Department,
          role: data.employee.Role
        };

        document.getElementById('headerUserInfo').textContent =
          currentUser.name + " â€“ " + currentUser.employeeId + " (" + currentUser.role + ")";

        document.getElementById('employeeNameBadge').textContent =
          currentUser.name + " â€“ " + currentUser.employeeId;

        const mgrTab = document.getElementById('managerTab');
        const adminTab = document.getElementById('adminTab');
        if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
          mgrTab.classList.remove('hidden');
        } else {
          mgrTab.classList.add('hidden');
        }
        if (currentUser.role === 'Admin') {
          adminTab.classList.remove('hidden');
        } else {
          adminTab.classList.add('hidden');
        }

        showView(true);
        initTabs();
        await loadEmployeeDashboard();

        if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
          await loadManagerPanelData();
        }

      } catch (err) {
        setAlert('loginAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function logout() {
      currentUser = null;
      document.getElementById('loginEmployeeId').value = "";
      document.getElementById('loginPin').value = "";
      showView(false);
    }

    function initTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const target = tab.getAttribute('data-target');
          ['employeePanel','managerPanel','adminPanel'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
          });
          if (target) {
            document.getElementById(target).classList.remove('hidden');
          }

          if (target === 'managerPanel' && currentUser &&
              (currentUser.role === 'Manager' || currentUser.role === 'Admin')) {
            loadManagerPanelData();
          }
          if (target === 'adminPanel' && currentUser && currentUser.role === 'Admin') {
            loadAdminReport();
          }
        });
      });
    }

    function formatDate(value) {
      if (!value) return '';
      const d = new Date(value);
      if (isNaN(d)) return String(value).split('T')[0] || String(value);
      return d.toISOString().split('T')[0];
    }

    function getMonthKey(value) {
      if (!value) return '';
      const d = new Date(value);
      if (isNaN(d)) {
        return String(value).slice(0, 7);
      }
      return d.toISOString().slice(0, 7);
    }

    // ========= Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆØ¸Ù =========

    function populateOTMonthFilter() {
      const select = document.getElementById('otMonthFilter');
      if (!select) return;

      const monthsSet = new Set();
      (employeeOTRecords || []).forEach(rec => {
        const key = getMonthKey(rec.Date);
        if (key) monthsSet.add(key);
      });

      const months = Array.from(monthsSet).sort();

      let optionsHtml = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>`;
      months.forEach(m => {
        optionsHtml += `<option value="${m}">${m}</option>`;
      });

      select.innerHTML = optionsHtml;
    }

    function renderEmployeeOvertimeTable() {
      const tbody = document.querySelector('#otTable tbody');
      const statsRow = document.getElementById('otStatsRow');
      const select = document.getElementById('otMonthFilter');

      if (!tbody || !statsRow || !select) return;

      const monthFilter = select.value;

      let filtered = employeeOTRecords || [];
      if (monthFilter) {
        filtered = filtered.filter(rec => getMonthKey(rec.Date) === monthFilter);
      }

      let totalHours = 0;
      let totalValue = 0;
      filtered.forEach(rec => {
        totalHours += Number(rec.Hours || 0);
        totalValue += Number(rec.Value || 0);
      });

      statsRow.innerHTML = `
        <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</span><strong>${totalHours}</strong></div>
        <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</span><strong>${totalValue}</strong></div>
      `;

      tbody.innerHTML = '';
      filtered.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rec.OTID}</td>
          <td>${formatDate(rec.Date)}</td>
          <td>${rec.Hours}</td>
          <td>${rec.Rate}</td>
          <td>${rec.Value}</td>
        `;
        tbody.appendChild(tr);
      });

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</td>`;
        tbody.appendChild(tr);
      }
    }

    async function loadEmployeeDashboard() {
      if (!currentUser) return;
      try {
        setAlert('employeeAlert', '', '');
        const data = await apiCall('getDashboard', {
          employeeId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!data.ok) {
          setAlert('employeeAlert', data.error || 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
          return;
        }

        const lb = data.leaveBalance || { annual: 0, used: 0, remaining: 0 };
        const statsRow = document.getElementById('leaveStatsRow');
        statsRow.innerHTML = `
          <div class="stat-pill"><span>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©</span><strong>${lb.annual}</strong></div>
          <div class="stat-pill"><span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† Ø§Ù„Ø³Ù†ÙˆÙŠØ©)</span><strong>${lb.used}</strong></div>
          <div class="stat-pill"><span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©</span><strong>${lb.remaining}</strong></div>
          <div class="stat-pill"><span>Ù…Ø±Ø¶ÙŠØ© Ù…Ø³ØªÙ‡Ù„ÙƒØ©</span><strong>${lb.sickUsed || 0} (Ù…Ø¬Ø§Ù†ÙŠØ©: ${lb.sickFree || 0})</strong></div>
          <div class="stat-pill"><span>Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ© Ù…Ø³ØªÙ‡Ù„ÙƒØ©</span><strong>${lb.exceptionalUsed || 0} (Ù…Ø¬Ø§Ù†ÙŠØ©: ${lb.exceptionalFree || 0})</strong></div>
        `;

        const leaveTbody = document.querySelector('#leaveTable tbody');
        leaveTbody.innerHTML = '';
        (data.leaves || []).forEach(req => {
          const statusClass =
            req.Status === 'Approved'
              ? 'status-approved'
              : req.Status === 'Rejected'
              ? 'status-rejected'
              : 'status-pending';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${req.RequestID}</td>
            <td>${formatDate(req.StartDate)}</td>
            <td>${formatDate(req.EndDate)}</td>
            <td>${req.Days}</td>
            <td>${req.Type || ''}</td>
            <td><span class="status-badge ${statusClass}">${req.Status}</span></td>
          `;
          leaveTbody.appendChild(tr);
        });

        employeeOTRecords = data.overtime.records || [];
        populateOTMonthFilter();
        renderEmployeeOvertimeTable();

      } catch (err) {
        setAlert('employeeAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function submitLeave() {
      if (!currentUser) return;

      const startDate = document.getElementById('leaveStartDate').value;
      const endDate = document.getElementById('leaveEndDate').value;
      const type = document.getElementById('leaveType').value;
      const comment = document.getElementById('leaveComment').value;

      if (!startDate || !endDate) {
        setAlert('employeeAlert', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©', 'error');
        return;
      }

      try {
        const data = await apiCall('submitLeave', {
          employeeId: currentUser.employeeId,
          pin: currentUser.pin,
          startDate,
          endDate,
          type,
          comment
        });

        if (!data.ok) {
          setAlert('employeeAlert', data.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©', 'error');
          return;
        }

        let msg = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­ (Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + data.requestId + ')';
        if (data.warning) {
          msg += ' | ' + data.warning;
        }

        setAlert('employeeAlert', msg, 'success');
        document.getElementById('leaveComment').value = '';
        await loadEmployeeDashboard();

        if (currentUser.role === 'Manager' || currentUser.role === 'Admin') {
          await loadManagerPanelData();
        }
      } catch (err) {
        setAlert('employeeAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    // ========= Ù„ÙˆØ­Ø© Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù… =========

    function populateManagerEmployeesSelect() {
      const sel = document.getElementById('mgrOtEmployeeSelect');
      if (!sel) return;

      let html = `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>`;
      (managerEmployeesList || []).forEach(e => {
        html += `<option value="${e.EmployeeID}">${e.Name} (${e.EmployeeID})</option>`;
      });
      sel.innerHTML = html;
    }

    async function loadManagerPanelData() {
      if (!currentUser) return;

      try {
        const data = await apiCall('getManagerLeaves', {
          managerId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©', 'error');
          return;
        }

        setAlert('managerAlert', '', '');

        const tbody = document.querySelector('#managerLeaveTable tbody');
        tbody.innerHTML = '';

        if (!data.leaves || data.leaves.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="9">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td>`;
          tbody.appendChild(tr);
        } else {
          data.leaves.forEach(req => {
            const tr = document.createElement('tr');
            const balBefore = (req.BalanceBefore !== null && req.BalanceBefore !== undefined) ? req.BalanceBefore : '';
            const balAfter = (req.BalanceAfter !== null && req.BalanceAfter !== undefined) ? req.BalanceAfter : '';
            tr.innerHTML = `
              <td>${req.RequestID}</td>
              <td>${req.EmployeeName || req.EmployeeID}</td>
              <td>${req.EmployeeDepartment || ''}</td>
              <td>${formatDate(req.StartDate)}</td>
              <td>${formatDate(req.EndDate)}</td>
              <td>${req.Days}</td>
              <td>${req.Type || ''}</td>
              <td>${balBefore} â†’ ${balAfter}</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="managerDecision(${req.RequestID}, 'Approved')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                <button class="btn btn-sm btn-secondary" onclick="managerDecision(${req.RequestID}, 'Rejected')">Ø±ÙØ¶</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        managerEmployeesList = data.managerEmployees || [];
        populateManagerEmployeesSelect();

        await loadManagerOvertime();

      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function managerDecision(requestId, status) {
      if (!currentUser) return;

      try {
        const data = await apiCall('approveLeave', {
          managerId: currentUser.employeeId,
          pin: currentUser.pin,
          requestId,
          status,
          comment: ''
        });

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', 'error');
          return;
        }

        setAlert('managerAlert', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.', 'success');

        await loadManagerPanelData();
        await loadEmployeeDashboard();

      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function managerAddOvertime() {
      if (!currentUser) return;

      const empId = document.getElementById('mgrOtEmployeeSelect').value;
      const date = document.getElementById('mgrOtDate').value;
      const hours = document.getElementById('mgrOtHours').value;
      const rate = document.getElementById('mgrOtRate').value;

      if (!empId || !date || !hours) {
        setAlert('managerAlert', 'ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª', 'error');
        return;
      }

      try {
        const payload = {
          managerId: currentUser.employeeId,
          pin: currentUser.pin,
          employeeId: empId,
          date,
          hours
        };
        if (rate) payload.rate = rate;

        const data = await apiCall('addOvertime', payload);

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ', 'error');
          return;
        }

        setAlert('managerAlert', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ù„Ù‚ÙŠÙ…Ø©: ' + data.value, 'success');
        document.getElementById('mgrOtHours').value = '';
        document.getElementById('mgrOtRate').value = '';

        await loadEmployeeDashboard();
        await loadManagerOvertime();
      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    async function loadManagerOvertime() {
      if (!currentUser) return;
      try {
        const data = await apiCall('getManagerOvertime', {
          managerId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!data.ok) {
          setAlert('managerAlert', data.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ', 'error');
          return;
        }

        managerOvertimeRecords = data.overtime || [];
        populateManagerOTMonthFilter();
        renderManagerOvertimeTable();

      } catch (err) {
        setAlert('managerAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function populateManagerOTMonthFilter() {
      const select = document.getElementById('mgrOtMonthFilter');
      if (!select) return;

      const monthsSet = new Set();
      (managerOvertimeRecords || []).forEach(rec => {
        const key = getMonthKey(rec.Date);
        if (key) monthsSet.add(key);
      });

      const months = Array.from(monthsSet).sort();
      let html = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>`;
      months.forEach(m => {
        html += `<option value="${m}">${m}</option>`;
      });
      select.innerHTML = html;
    }

    function renderManagerOvertimeTable() {
      const tbody = document.querySelector('#mgrOtTable tbody');
      const statsRow = document.getElementById('mgrOtStatsRow');
      const select = document.getElementById('mgrOtMonthFilter');

      if (!tbody || !statsRow || !select) return;

      const monthFilter = select.value;
      let filtered = managerOvertimeRecords || [];

      if (monthFilter) {
        filtered = filtered.filter(rec => getMonthKey(rec.Date) === monthFilter);
      }

      let totalHours = 0;
      let totalValue = 0;
      filtered.forEach(rec => {
        totalHours += Number(rec.Hours || 0);
        totalValue += Number(rec.Value || 0);
      });

      statsRow.innerHTML = `
        <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª (Ø§Ù„Ù‚Ø³Ù…)</span><strong>${totalHours}</strong></div>
        <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ø§Ù„Ù‚Ø³Ù…)</span><strong>${totalValue}</strong></div>
      `;

      tbody.innerHTML = '';
      filtered.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rec.OTID}</td>
          <td>${rec.EmployeeName || rec.EmployeeID}</td>
          <td>${rec.EmployeeDepartment || ''}</td>
          <td>${formatDate(rec.Date)}</td>
          <td>${rec.Hours}</td>
          <td>${rec.Rate}</td>
          <td>${rec.Value}</td>
        `;
        tbody.appendChild(tr);
      });

      if (filtered.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¥Ø¶Ø§ÙÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</td>`;
        tbody.appendChild(tr);
      }
    }

    // ========= Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© =========

    async function loadAdminReport() {
      if (!currentUser) return;
      try {
        const rep = await apiCall('adminReport', {
          adminId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!rep.ok) {
          setAlert('adminAlert', rep.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
          return;
        }

        setAlert('adminAlert', '', '');
        const s = rep.summary;
        const div = document.getElementById('adminSummary');
        div.innerHTML = `
          <div class="stats-row">
            <div class="stat-pill"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span><strong>${s.totalEmployees}</strong></div>
            <div class="stat-pill"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</span><strong>${s.leave.pending}</strong></div>
            <div class="stat-pill"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ù‚Ø¨ÙˆÙ„Ø©</span><strong>${s.leave.approved}</strong></div>
            <div class="stat-pill"><span>Ø·Ù„Ø¨Ø§Øª Ù…Ø±ÙÙˆØ¶Ø©</span><strong>${s.leave.rejected}</strong></div>
          </div>
          <div class="stats-row">
            <div class="stat-pill"><span>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</span><strong>${s.overtime.totalHours}</strong></div>
            <div class="stat-pill"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</span><strong>${s.overtime.totalValue}</strong></div>
          </div>
        `;

        const det = await apiCall('adminDetails', {
          adminId: currentUser.employeeId,
          pin: currentUser.pin
        });

        if (!det.ok) {
          setAlert('adminAlert', det.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'error');
          return;
        }

        adminEmployees = det.employees || [];
        adminLeaves = det.leaves || [];
        adminOvertime = det.overtime || [];

        populateAdminFilters();
        renderAdminEmployeesTable();
        renderAdminLeavesTable();
        renderAdminOvertimeTable();

      } catch (err) {
        setAlert('adminAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function populateAdminFilters() {
      const deptSet = new Set();
      adminEmployees.forEach(e => {
        if (e.Department) deptSet.add(String(e.Department));
      });

      const departments = Array.from(deptSet).sort();

      function fillSelect(id, withAllText) {
        const sel = document.getElementById(id);
        if (!sel) return;
        let html = `<option value="">${withAllText}</option>`;
        departments.forEach(d => {
          html += `<option value="${d}">${d}</option>`;
        });
        sel.innerHTML = html;
      }

      fillSelect('admEmpDeptFilter', 'ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');
      fillSelect('admLeaveDeptFilter', 'ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');
      fillSelect('admOtDeptFilter', 'ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');

      const monthSet = new Set();
      (adminOvertime || []).forEach(rec => {
        const key = getMonthKey(rec.Date);
        if (key) monthSet.add(key);
      });
      const months = Array.from(monthSet).sort();
      const selMonth = document.getElementById('admOtMonthFilter');
      if (selMonth) {
        let html = `<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>`;
        months.forEach(m => {
          html += `<option value="${m}">${m}</option>`;
        });
        selMonth.innerHTML = html;
      }
    }

    function renderAdminEmployeesTable() {
      const tbody = document.querySelector('#admEmpTable tbody');
      if (!tbody) return;

      const dept = document.getElementById('admEmpDeptFilter').value;
      const role = document.getElementById('admEmpRoleFilter').value;
      const active = document.getElementById('admEmpActiveFilter').value;

      let rows = adminEmployees || [];

      rows = rows.filter(e => {
        if (dept && String(e.Department) !== dept) return false;
        if (role && String(e.Role) !== role) return false;

        if (active) {
          const isActive = String(e.IsActive || '').toLowerCase();
          if (active === 'Active' && isActive === 'false') return false;
          if (active === 'Inactive' && isActive !== 'false') return false;
        }
        return true;
      });

      tbody.innerHTML = '';
      rows.forEach(e => {
        const tr = document.createElement('tr');
        const isActive = String(e.IsActive || '').toLowerCase() !== 'false' ? 'âœ…' : 'âŒ';
        tr.innerHTML = `
          <td>${e.EmployeeID || ''}</td>
          <td>${e.Name || ''}</td>
          <td>${e.Department || ''}</td>
          <td>${e.Role || ''}</td>
          <td>${e.Email || ''}</td>
          <td>${isActive}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderAdminLeavesTable() {
      const tbody = document.querySelector('#admLeaveTable tbody');
      if (!tbody) return;

      const dept = document.getElementById('admLeaveDeptFilter').value;
      const status = document.getElementById('admLeaveStatusFilter').value;
      const type = document.getElementById('admLeaveTypeFilter').value;

      let rows = adminLeaves || [];

      rows = rows.filter(r => {
        if (dept && String(r.EmployeeDepartment) !== dept) return false;
        if (status && String(r.Status) !== status) return false;
        if (type && String(r.Type) !== type) return false;
        return true;
      });

      tbody.innerHTML = '';
      rows.forEach(r => {
        const statusClass =
          r.Status === 'Approved'
            ? 'status-approved'
            : r.Status === 'Rejected'
            ? 'status-rejected'
            : 'status-pending';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.RequestID}</td>
          <td>${r.EmployeeName || r.EmployeeID}</td>
          <td>${r.EmployeeDepartment || ''}</td>
          <td>${formatDate(r.StartDate)}</td>
          <td>${formatDate(r.EndDate)}</td>
          <td>${r.Days}</td>
          <td>${r.Type || ''}</td>
          <td><span class="status-badge ${statusClass}">${r.Status}</span></td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</td>`;
        tbody.appendChild(tr);
      }
    }

    function renderAdminOvertimeTable() {
      const tbody = document.querySelector('#admOtTable tbody');
      const statsRow = document.getElementById('admOtStatsRow');
      if (!tbody || !statsRow) return;

      const dept = document.getElementById('admOtDeptFilter').value;
      const month = document.getElementById('admOtMonthFilter').value;

      let rows = adminOvertime || [];

      rows = rows.filter(r => {
        if (dept && String(r.EmployeeDepartment) !== dept) return false;
        if (month && getMonthKey(r.Date) !== month) return false;
        return true;
      });

      let totalHours = 0;
      let totalValue = 0;
      rows.forEach(r => {
        totalHours += Number(r.Hours || 0);
        totalValue += Number(r.Value || 0);
      });

      statsRow.innerHTML = `
        <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</span><strong>${totalHours}</strong></div>
        <div class="stat-pill"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</span><strong>${totalValue}</strong></div>
      `;

      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.OTID}</td>
          <td>${r.EmployeeName || r.EmployeeID}</td>
          <td>${r.EmployeeDepartment || ''}</td>
          <td>${formatDate(r.Date)}</td>
          <td>${r.Hours}</td>
          <td>${r.Rate}</td>
          <td>${r.Value}</td>
        `;
        tbody.appendChild(tr);
      });

      if (rows.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</td>`;
        tbody.appendChild(tr);
      }
    }

    // ========= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =========

    function openEmployeeRequests() {
      if (!currentUser) return;
      document.getElementById('requestsOverlay').classList.remove('hidden');
      document.getElementById('requestsEmployeeView').classList.remove('hidden');
      document.getElementById('requestsAdminView').classList.add('hidden');
      loadEmployeeRequests();
    }

    function openAdminRequests() {
      if (!currentUser || currentUser.role !== 'Admin') return;
      document.getElementById('requestsOverlay').classList.remove('hidden');
      document.getElementById('requestsEmployeeView').classList.add('hidden');
      document.getElementById('requestsAdminView').classList.remove('hidden');
      loadAdminRequests();
    }

    function closeRequestsOverlay() {
      document.getElementById('requestsOverlay').classList.add('hidden');
    }

    function setReqAlert(id, message, type) {
      const el = document.getElementById(id);
      if (!el) return;
      if (!message) {
        el.classList.add('hidden');
        return;
      }
      el.textContent = message;
      el.classList.remove('hidden');
      el.classList.remove('alert-success', 'alert-error');
      if (type === 'success') el.classList.add('alert-success');
      else el.classList.add('alert-error');
    }

    // ---- Ø¬Ø²Ø¡ Ø§Ù„Ù…ÙˆØ¸Ù ----

    async function loadEmployeeRequests() {
      if (!currentUser) return;
      try {
        setReqAlert('reqEmployeeAlert', '', '');
        const res = await apiCall('getEmployeeRequests', {
          employeeId: currentUser.employeeId,
          pin: currentUser.pin
        });
        if (!res.ok) {
          setReqAlert('reqEmployeeAlert', res.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª', 'error');
          return;
        }
        employeeRequests = res.requests || [];
        renderEmployeeRequestsTable();
      } catch (err) {
        setReqAlert('reqEmployeeAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function renderEmployeeRequestsTable() {
      const tbody = document.querySelector('#employeeReqTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      (employeeRequests || []).forEach(r => {
        const statusClass =
          r.Status === 'Approved'
            ? 'status-approved'
            : r.Status === 'Rejected'
            ? 'status-rejected'
            : 'status-pending';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.RequestID}</td>
          <td>${r.Type || ''}</td>
          <td>${r.Subject || ''}</td>
          <td><span class="status-badge ${statusClass}">${r.Status || ''}</span></td>
          <td>${formatDate(r.CreatedAt)}</td>
          <td>${r.AdminReply || ''}</td>
        `;
        tbody.appendChild(tr);
      });

      if (!employeeRequests || employeeRequests.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td>`;
        tbody.appendChild(tr);
      }
    }

    async function submitEmployeeRequest() {
      if (!currentUser) return;

      const type         = document.getElementById('reqType').value;
      const subject      = document.getElementById('reqSubject').value.trim();
      const description  = document.getElementById('reqDescription').value.trim();
      const amount       = document.getElementById('reqAmount').value;
      const installment  = document.getElementById('reqInstallment').value;
      const training     = document.getElementById('reqTraining').value.trim();
      const transferDept = document.getElementById('reqTransferDept').value.trim();

      if (!subject || !description) {
        setReqAlert('reqEmployeeAlert', 'ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† ÙˆØ´Ø±Ø­ Ù„Ù„Ø·Ù„Ø¨', 'error');
        return;
      }

      try {
        const res = await apiCall('submitRequest', {
          employeeId: currentUser.employeeId,
          pin: currentUser.pin,
          type,
          subject,
          description,
          amount,
          installment,
          training,
          transferDept
        });

        if (!res.ok) {
          setReqAlert('reqEmployeeAlert', res.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', 'error');
          return;
        }

        setReqAlert('reqEmployeeAlert',
          'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ (Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ' + res.requestId + ')',
          'success'
        );

        document.getElementById('reqSubject').value = '';
        document.getElementById('reqDescription').value = '';
        document.getElementById('reqAmount').value = '';
        document.getElementById('reqInstallment').value = '';
        document.getElementById('reqTraining').value = '';
        document.getElementById('reqTransferDept').value = '';

        await loadEmployeeRequests();
      } catch (err) {
        setReqAlert('reqEmployeeAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    // ---- Ø¬Ø²Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ----

    async function loadAdminRequests() {
      if (!currentUser || currentUser.role !== 'Admin') return;
      try {
        setReqAlert('reqAdminAlert', '', '');
        const res = await apiCall('adminGetRequests', {
          adminId: currentUser.employeeId,
          pin: currentUser.pin
        });
        if (!res.ok) {
          setReqAlert('reqAdminAlert', res.error || 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', 'error');
          return;
        }
        adminRequests = res.requests || [];
        renderAdminRequestsTable();
      } catch (err) {
        setReqAlert('reqAdminAlert', err.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹', 'error');
      }
    }

    function renderAdminRequestsTable() {
      const tbody = document.querySelector('#adminReqTable tbody');
      if (!tbody) return;
      tbody.innerHTML = '';

      (adminRequests || []).forEach(r => {
        const statusClass =
          r.Status === 'Approved'
            ? 'status-approved'
            : r.Status === 'Rejected'
            ? 'status-rejected'
            : 'status-pending';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.RequestID}</td>
          <td>${r.EmployeeName || r.EmployeeID}</td>
          <td>${r.EmployeeDepartment || ''}</td>
          <td>${r.Type || ''}</td>
          <td>${r.Subject || ''}</td>
          <td><span class="status-badge ${statusClass}">${r.Status || ''}</span></td>
          <td>${formatDate(r.CreatedAt)}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="openRequestDetails(${r.RequestID})">
              ØªÙØ§ØµÙŠÙ„
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      if (!adminRequests || adminRequests.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td>`;
        tbody.appendChild(tr);
      }
    }

    // ğŸ†• ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ + Ø­ÙØ¸ Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    function openRequestDetails(requestId) {
      currentOpenedRequestId = requestId;
      const r = adminRequests.find(x => Number(x.RequestID) === Number(requestId));
      if (!r) return;

      const html = `
        <table style="width:100%;font-size:0.85rem;border-collapse:collapse;">
          <tr><td style="text-align:right;padding:3px 4px;"><b>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:</b></td><td style="text-align:right;padding:3px 4px;">${r.RequestID}</td></tr>
          <tr><td><b>Ø§Ù„Ù…ÙˆØ¸Ù:</b></td><td>${r.EmployeeName || ''} (${r.EmployeeID || ''})</td></tr>
          <tr><td><b>Ø§Ù„Ù‚Ø³Ù…:</b></td><td>${r.EmployeeDepartment || ''}</td></tr>
          <tr><td><b>Ø§Ù„Ù†ÙˆØ¹:</b></td><td>${r.Type || ''}</td></tr>
          <tr><td><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b></td><td>${r.Subject || ''}</td></tr>
          <tr><td><b>Ø§Ù„ÙˆØµÙ:</b></td><td>${r.Description || ''}</td></tr>
          <tr><td><b>Ø§Ù„Ù…Ø¨Ù„Øº:</b></td><td>${r.Amount || ''}</td></tr>
          <tr><td><b>Ø§Ù„ØªÙ‚Ø³ÙŠØ·:</b></td><td>${r.Installment || ''}</td></tr>
          <tr><td><b>Ø§Ù„ØªØ¯Ø±ÙŠØ¨:</b></td><td>${r.Training || ''}</td></tr>
          <tr><td><b>Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØªØ­ÙˆÙŠÙ„:</b></td><td>${r.TransferDept || ''}</td></tr>
          <tr><td><b>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</b></td><td>${r.Status || ''}</td></tr>
          <tr><td><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</b></td><td>${formatDate(r.CreatedAt)}</td></tr>
          <tr><td><b>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚Ø±Ø§Ø±:</b></td><td>${r.DecisionAt || ''}</td></tr>
          <tr><td><b>Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ:</b></td><td>${r.AdminID || ''}</td></tr>
          <tr><td><b>Ø±Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚:</b></td><td>${r.AdminReply || ''}</td></tr>
        </table>
      `;
      document.getElementById('requestDetailsContent').innerHTML = html;
      document.getElementById('adminReplyInput').value = r.AdminReply || '';
      document.getElementById('requestDetailsModal').classList.remove('hidden');
    }

    function closeRequestDetails() {
      document.getElementById('requestDetailsModal').classList.add('hidden');
      currentOpenedRequestId = null;
    }

    async function saveAdminRequestAction(actionType) {
      if (!currentUser || currentUser.role !== 'Admin' || !currentOpenedRequestId) return;

      const r = adminRequests.find(x => Number(x.RequestID) === Number(currentOpenedRequestId));
      if (!r) return;

      let statusToSend = r.Status || 'Pending';
      if (actionType === 'Approved' || actionType === 'Rejected') {
        statusToSend = actionType;
      }

      const reply = document.getElementById('adminReplyInput').value || '';

      try {
        const res = await apiCall('adminUpdateRequest', {
          adminId: currentUser.employeeId,
          pin: currentUser.pin,
          requestId: currentOpenedRequestId,
          status: statusToSend,
          reply
        });

        if (!res.ok) {
          alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ' + (res.error || ''));
          return;
        }

        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
        closeRequestDetails();
        await loadAdminRequests();
        await loadEmployeeRequests(); // Ù„Ùˆ Ø§Ù„Ù…ÙˆØ¸Ù ÙØ§ØªØ­ ÙˆØ§Ø¬Ù‡ØªÙ‡
      } catch (err) {
        alert('Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + (err.message || err));
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      showView(false);
    });
  </script>
</body>
</html>
